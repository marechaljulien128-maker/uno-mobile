<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>UNO Firebase + Avancé</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background-color: #2c3e50; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Styles existants (inchangés, sauf ajustements mineurs) */
        #game-info { padding: 10px; background: #34495e; }
        #status { font-weight: bold; color: #f1c40f; }
        #table { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .card-pile { width: 80px; height: 120px; border-radius: 8px; border: 3px solid white; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; background: #95a5a6; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        #hand-container { height: 160px; background: #222; overflow-x: auto; display: flex; align-items: center; padding: 0 10px; gap: 5px; }
        .card { 
            min-width: 70px; height: 110px; border-radius: 6px; display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 20px; color: white; cursor: pointer; border: 2px solid #fff; position: relative;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-10px); }
        .Rouge { background: #e74c3c; }
        .Bleu { background: #3498db; }
        .Vert { background: #2ecc71; }
        .Jaune { background: #f1c40f; color: black; }
        .Noire { background: #2c3e50; border: 2px dashed white; } /* Dos de carte */
        button { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 16px; margin-top: 10px; cursor: pointer; }
        button:disabled { background: #7f8c8d; }
        #controls { margin: 10px; }

        /* Nouveaux styles */
        #opponents { display: flex; justify-content: space-around; width: 100%; padding: 10px; }
        .opponent { text-align: center; }
        .uno-button-container { display: flex; justify-content: center; margin-top: 10px; }
        .uno-button-container button { margin: 0 10px; }
        .card-animation {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            position: absolute;
            z-index: 10; /* Au-dessus des autres cartes */
        }
    </style>
</head>
<body>

    <div id="game-info">
        <div>Joueurs connectés: <span id="player-count">0</span></div>
        <div id="status">Chargement...</div>
    </div>

    <!-- Affichage du nombre de cartes des adversaires -->
    <div id="opponents">
        <!-- Rempli dynamiquement par JavaScript -->
    </div>

    <div id="table">
        <!-- La défausse -->
        <div id="discard-pile" class="card-pile">?</div>
        
        <div id="controls">
            <button id="btn-draw" onclick="drawCard()">Piocher</button>
            <button id="btn-start" onclick="startGame()" style="display:none; background-color: #e67e22;">Démarrer la partie</button>
            <button id="btn-quit" onclick="quitGame()" style="background-color: #c0392b;">Quitter la partie</button>
        </div>

        <!-- Boutons UNO / Contre-UNO -->
       <div class="uno-button-container">
            <button id="btn-uno" onclick="callUno()" disabled>UNO</button>
            <button id="btn-counter-uno" onclick="counterUno()" disabled>Contre UNO</button>
        </div>
    </div>

    <div id="hand-container">
        <!-- Les cartes du joueur iront ici -->
    </div>

    <!-- Import Firebase Modular SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push, runTransaction, get, remove } 
        from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // ------------------------------------------------------------------
        // CONFIGURATION FIREBASE (A REMPLACER PAR LA VOTRE)
        // ------------------------------------------------------------------
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyC8muWc77SYBV9IKdltyW2s_2-vz6Seu7M",
          authDomain: "uno-mobile-d506d.firebaseapp.com",
          databaseURL: "https://uno-mobile-d506d-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "uno-mobile-d506d",
          storageBucket: "uno-mobile-d506d.firebasestorage.app",
          messagingSenderId: "505946389294",
          appId: "1:505946389294:web:38720c49913319b7a798bf",
          measurementId: "G-14ZHV63WTD"
        };

        // Initialisation
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Identifiant unique local pour ce téléphone (stocké dans le navigateur)
        let myId = localStorage.getItem('uno_player_id');
        if (!myId) {
            myId = 'player_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('uno_player_id', myId);
        }

        const ROOM_ID = "salon_1"; // Une seule salle pour l'instant
        const gameRef = ref(db, 'games/' + ROOM_ID);
        let gameState = null;
        let myHand = [];
        let unoCalled = false; // Pour suivre si j'ai annoncé UNO

        // --- GESTION DE LA CONNEXION ---
        const playerRef = ref(db, `games/${ROOM_ID}/players/${myId}`);
        set(playerRef, {
            name: "Joueur " + myId.substr(0,4),
            active: true,
            unoCalled: false // Initialiser
        });

        // Supprimer le joueur s'il quitte (optionnel mais propre)
        // onDisconnect(playerRef).remove(); 

        // --- ECOUTER LES MISES A JOUR DE LA DATABASE ---
        onValue(gameRef, (snapshot) => {
            gameState = snapshot.val();
            
            if (!gameState) {
                document.getElementById('status').innerText = "En attente de lancement...";
                document.getElementById('btn-start').style.display = 'inline-block';
                return;
            }

            // Mise à jour du compteur de joueurs
            const players = gameState.players || {};
            const playerIds = Object.keys(players);
            document.getElementById('player-count').innerText = playerIds.length;

            // Afficher bouton start seulement si pas commencé et au moins 2 joueurs
            if (!gameState.started && playerIds.length >= 2) {
                document.getElementById('btn-start').style.display = 'inline-block';
            } else {
                document.getElementById('btn-start').style.display = 'none';
            }

            if (gameState.started) {
                renderGame();
            }
        });

        // --- FONCTIONS DU JEU (Exportées globalement pour les onclick HTML) ---
        
        window.startGame = function() {
            // Générer le deck
            const colors = ['Rouge', 'Bleu', 'Vert', 'Jaune'];
            const values = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '+2', 'Sens', 'Passe', 'Joker', '+4']; // Complet
            let deck = [];
            
            colors.forEach(c => values.forEach(v => {
                deck.push({ color: c, value: v });
                if(v !== '0' && v !== 'Joker' && v !== '+4') deck.push({ color: c, value: v }); // Deux fois sauf le 0 et les spéciales
            }));
            // Jokers
            for(let i = 0; i < 4; i++) {
                deck.push({ color: 'Noire', value: 'Joker' });
                deck.push({ color: 'Noire', value: '+4' });
            }
            
            // Mélanger
            deck.sort(() => Math.random() - 0.5);

            // Distribuer
            get(ref(db, `games/${ROOM_ID}/players`)).then((snap) => {
                const players = snap.val();
                const pIds = Object.keys(players);
                let updates = {};

                pIds.forEach(pid => {
                    updates[`games/${ROOM_ID}/players/${pid}/hand`] = deck.splice(0, 7);
                    updates[`games/${ROOM_ID}/players/${pid}/unoCalled`] = false; // Réinitialiser le UNO
                });

                const firstCard = deck.pop();

                updates[`games/${ROOM_ID}/deck`] = deck;
                updates[`games/${ROOM_ID}/discard`] = firstCard;
                updates[`games/${ROOM_ID}/currentTurn`] = pIds[0]; // Le premier commence
                updates[`games/${ROOM_ID}/order`] = pIds; // Ordre du tour
                updates[`games/${ROOM_ID}/started`] = true;
                updates[`games/${ROOM_ID}/unoChallenged`] = null; // Personne n'a contesté le UNO

                update(ref(db), updates);
            });
        };

        window.drawCard = function() {
            if (!isMyTurn()) return;
            
            // Logique simplifiée : on prend une carte du "deck" virtuel (si vide on triche pour l'exemple)
            // Dans une vraie app il faudrait gérer le mélange de la défausse
            const deck = gameState.deck || [];
            if(deck.length === 0) return alert("Plus de cartes !");

            const card = deck.pop(); // On retire la dernière
            
            // Mise à jour atomique
            let myNewHand = gameState.players[myId].hand || [];
            myNewHand.push(card);

            update(ref(db, `games/${ROOM_ID}`), {
                deck: deck,
                [`players/${myId}/hand`]: myNewHand
            }).then(() => nextTurn());
        };

        window.playCard = function(index) {
            if (!isMyTurn()) return;

            const card = gameState.players[myId].hand[index];
            const topCard = gameState.discard;

            if (card.color === topCard.color || card.value === topCard.value || card.color === 'Noire') { // Carte noire = Joker
                // Coup valide
                let newHand = [...gameState.players[myId].hand];
                newHand.splice(index, 1);

                let updates = {};
                updates[`games/${ROOM_ID}/discard`] = card;
                updates[`games/${ROOM_ID}/players/${myId}/hand`] = newHand;
                updates[`games/${ROOM_ID}/players/${myId}/unoCalled`] = false; // Reset UNO

                // Gérer la victoire
                if (newHand.length === 0) {
                    updates[`games/${ROOM_ID}/winner`] = myId;
                    updates[`games/${ROOM_ID}/started`] = false; // Reset
                    alert("Gagné !");
                }
                else if(newHand.length === 1 && !unoCalled) {
                    alert("N'oublie pas de dire UNO!");
                }

                // Effet visuel (simplifié)
                animateCardMovement(index);

                update(ref(db), updates).then(() => {
                    if (newHand.length > 0) nextTurn();
                });
            } else {
                alert("Carte invalide !");
            }
        };

        window.quitGame = function() {
            remove(ref(db, `games/${ROOM_ID}/players/${myId}`)).then(() => {
                // Réinitialiser l'état local (important !)
                localStorage.removeItem('uno_player_id');
                location.reload(); // Recharge la page pour forcer une nouvelle connexion
            });
        };

        window.callUno = function() {
            unoCalled = true;
            update(playerRef, { unoCalled: true });
        };

        window.counterUno = function() {
            if (gameState.unoChallenged) return; // Déjà contesté

            const previousPlayerId = findPreviousPlayer(); // Trouver le joueur précédent
            const previousPlayer = gameState.players[previousPlayerId];

            if (previousPlayer && previousPlayer.hand && previousPlayer.hand.length === 1 && !previousPlayer.unoCalled) {
                // Contre-UNO valide
                alert("Contre-UNO réussi ! " + previousPlayer.name + " pioche 2 cartes.");

                // Piocher 2 cartes pour le joueur précédent
                drawPenaltyCards(previousPlayerId, 2);

                // Indiquer qu'il y a eu un contre-UNO
                update(gameRef, { unoChallenged: myId });
            } else {
                alert("Contre-UNO invalide !");
            }
        };

        // --- LOGIQUE INTERNE ---

        function isMyTurn() {
            return gameState.currentTurn === myId;
        }

        function nextTurn() {
            const order = gameState.order;
            const currentIndex = order.indexOf(myId);
            const nextIndex = (currentIndex + 1) % order.length;
            const nextPlayerId = order[nextIndex];
            
            update(ref(db, `games/${ROOM_ID}`), {
                currentTurn: nextPlayerId
            });
        }

        function findPreviousPlayer() {
            const order = gameState.order;
            const currentIndex = order.indexOf(myId);
            const previousIndex = (currentIndex - 1 + order.length) % order.length; // Pour gérer le retour au début
            return order[previousIndex];
        }

        function drawPenaltyCards(playerId, amount) {
            let deck = gameState.deck || [];
            let playerHand = gameState.players[playerId].hand || [];

            for (let i = 0; i < amount; i++) {
                if (deck.length === 0) break; // Plus de cartes
                playerHand.push(deck.pop());
            }

            update(ref(db, `games/${ROOM_ID}`), {
                deck: deck,
                [`players/${playerId}/hand`]: playerHand
            });
        }

        function renderGame() {
            // Afficher la défausse
            const discardDiv = document.getElementById('discard-pile');
            const topCard = gameState.discard;
            discardDiv.className = `card-pile ${topCard.color}`;
            discardDiv.innerText = topCard.value;

            // Afficher le statut
            const statusDiv = document.getElementById('status');
            if (isMyTurn()) {
                statusDiv.innerText = "C'EST À TOI DE JOUER !";
                statusDiv.style.color = "#2ecc71";
                document.body.style.border = "5px solid #2ecc71";
            } else {
                statusDiv.innerText = "Tour de l'adversaire...";
                statusDiv.style.color = "#f1c40f";
                document.body.style.border = "none";
            }

            // Afficher ma main
            const handContainer = document.getElementById('hand-container');
            handContainer.innerHTML = '';
            
            const myHand = gameState.players[myId].hand || [];
            myHand.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${card.color}`;
                cardEl.innerText = card.value;
                cardEl.onclick = () => window.playCard(index); // Appel global
                handContainer.appendChild(cardEl);
            });

             // Activer/désactiver le bouton UNO
            const btnUno = document.getElementById('btn-uno');
            if (myHand.length === 1 && !unoCalled) {
                btnUno.disabled = false;
            } else {
                btnUno.disabled = true;
            }
            // Activer/désactiver le bouton Contre-UNO
            const btnCounterUno = document.getElementById('btn-counter-uno');
            btnCounterUno.disabled = !gameState.unoChallenged; // Seulement si quelqu'un a dit UNO

            renderOpponents();
        }

        function renderOpponents() {
            const opponentsDiv = document.getElementById('opponents');
            opponentsDiv.innerHTML = ''; // Vider

            const players = gameState.players || {};
            for (const playerId in players) {
                if (playerId !== myId) {
                    const player = players[playerId];
                    const opponentDiv = document.createElement('div');
                    opponentDiv.className = 'opponent';
                    opponentDiv.innerHTML = `
                        ${player.name}<br>
                        Cartes: ${player.hand ? player.hand.length : 0}
                    `;
                    opponentsDiv.appendChild(opponentDiv);
                }
            }
        }

        function animateCardMovement(index) {
            const cardElement = document.querySelector(`#hand-container > div:nth-child(${index + 1})`);

            if (!cardElement) return;

            // Position de départ (carte dans la main)
            const startRect = cardElement.getBoundingClientRect();

            // Position d'arrivée (pile de défausse)
            const discardPile = document.getElementById('discard-pile');
            const endRect = discardPile.getBoundingClientRect();

            // Créer une copie de la carte pour l'animation
            const animatedCard = cardElement.cloneNode(true);
            animatedCard.classList.add('card-animation');
            animatedCard.style.position = 'absolute';
            animatedCard.style.left = `${startRect.left}px`;
            animatedCard.style.top = `${startRect.top}px`;
            document.body.appendChild(animatedCard);

            // Forcer un repaint pour que la transition fonctionne
            animatedCard.offsetWidth;

            // Appliquer la transformation
            animatedCard.style.transform = `translate(${endRect.left - startRect.left}px, ${endRect.top - startRect.top}px)`;
            animatedCard.style.opacity = '0';

            // Supprimer la carte animée après la transition
            setTimeout(() => {
                animatedCard.remove();
            }, 500);
        }
    </script>
</body>
</html>